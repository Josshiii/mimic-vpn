<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mimic Link</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --bg-color: #0f0f13;
        --card-bg: rgba(30, 30, 35, 0.7);
        --primary: #6366f1; /* Indigo */
        --primary-glow: rgba(99, 102, 241, 0.4);
        --success: #10b981; /* Green */
        --error: #ef4444; /* Red */
        --text-main: #ffffff;
        --text-dim: #9ca3af;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }

      body {
        background-color: var(--bg-color);
        background-image: radial-gradient(circle at 50% 0%, #2d2d44 0%, var(--bg-color) 70%);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }

      /* TARJETA PRINCIPAL (EFECTO CRISTAL) */
      .app-card {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 100%;
        height: 100%;
        max-width: 420px; /* Ancho mÃ³vil/launcher */
        max-height: 620px;
        border-radius: 24px;
        padding: 40px 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        position: relative;
      }

      /* HEADER */
      .logo-area { text-align: center; margin-bottom: 40px; }
      h1 { font-size: 28px; font-weight: 800; letter-spacing: -1px; background: linear-gradient(to right, #fff, #a5b4fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .subtitle { color: var(--text-dim); font-size: 13px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-top: 5px; }

      /* INPUT GIGANTE DE CÃ“DIGO */
      .code-container { width: 100%; margin-bottom: 20px; position: relative; }
      
      .code-label {
        position: absolute;
        top: -10px; left: 15px;
        background: var(--bg-color); /* Parche para tapar borde */
        padding: 0 5px;
        font-size: 12px; color: var(--primary); font-weight: bold;
        border-radius: 4px;
      }

      input#room-code {
        width: 100%;
        background: rgba(0,0,0,0.3);
        border: 2px solid #333;
        border-radius: 16px;
        padding: 20px;
        font-size: 24px;
        font-weight: 800;
        color: white;
        text-align: center;
        letter-spacing: 4px;
        text-transform: uppercase;
        transition: all 0.3s ease;
        outline: none;
      }

      input#room-code:focus {
        border-color: var(--primary);
        box-shadow: 0 0 20px var(--primary-glow);
      }

      input::placeholder { color: #444; letter-spacing: 1px; font-weight: 600; font-size: 18px; }

      /* BOTÃ“N DE ACCIÃ“N */
      button#btn-cloud {
        width: 100%;
        padding: 18px;
        border-radius: 16px;
        border: none;
        background: var(--primary);
        color: white;
        font-size: 16px; font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 15px var(--primary-glow);
        margin-bottom: 30px;
      }

      button#btn-cloud:hover { transform: translateY(-2px); filter: brightness(1.1); }
      button#btn-cloud:active { transform: translateY(1px); }
      button:disabled { opacity: 0.7; cursor: wait; }

      /* ANILLO DE ESTADO (Visual Feedback) */
      .status-ring {
        width: 120px; height: 120px;
        border-radius: 50%;
        border: 4px solid #333;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        margin-bottom: 30px;
        transition: all 0.5s ease;
        position: relative;
      }

      .status-ring.connecting { border-color: #fbbf24; box-shadow: 0 0 15px #fbbf2455; animation: pulse 1.5s infinite; }
      .status-ring.online { border-color: var(--success); box-shadow: 0 0 20px var(--success); background: rgba(16, 185, 129, 0.1); }
      .status-ring.error { border-color: var(--error); box-shadow: 0 0 15px var(--error); }

      .status-icon { font-size: 32px; margin-bottom: 5px; }
      .status-text { font-size: 12px; font-weight: 600; color: var(--text-dim); text-align: center; }

      /* SECCIÃ“N AVANZADA (OCULTA) */
      .advanced-toggle {
        font-size: 12px; color: #555; cursor: pointer; text-decoration: underline;
        margin-top: auto; /* Empuja al fondo */
      }
      .advanced-panel {
        display: none; width: 100%; margin-top: 20px;
        background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px;
      }
      .advanced-panel.open { display: block; }
      
      .mini-input {
        width: 100%; background: #222; border: 1px solid #444; color: #888;
        padding: 8px; border-radius: 6px; font-family: monospace; font-size: 11px; margin-bottom: 5px;
      }

      @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    </style>
  </head>
  <body>

    <div class="app-card">
      <div class="logo-area">
        <h1>Mimic Link</h1>
        <p class="subtitle">Secure Gaming Tunnel</p>
      </div>

      <div id="status-ring" class="status-ring">
        <div id="status-icon" class="status-icon">ðŸ”Œ</div>
        <div id="status-label" class="status-text">OFFLINE</div>
      </div>

      <div class="code-container">
        <span class="code-label">CÃ“DIGO DE SALA</span>
        <input id="room-code" placeholder="EJ: HALO" autocomplete="off" maxlength="10">
      </div>

      <button id="btn-cloud">CONECTAR</button>

      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <div id="led-tx" style="width: 8px; height: 8px; border-radius: 50%; background: #333; transition: 0.1s;"></div>
        <div id="led-rx" style="width: 8px; height: 8px; border-radius: 50%; background: #333; transition: 0.1s;"></div>
      </div>

      <div class="advanced-toggle" id="toggle-advanced">Opciones Avanzadas</div>
      
      <div class="advanced-panel" id="advanced-panel">
         <label style="font-size:10px; color:#666;">IP Virtual (Tu ID)</label>
         <input id="ip-virtual" class="mini-input" value="10.10.10.2">
         <label style="font-size:10px; color:#666;">Puerto Local</label>
         <input id="puerto-local" class="mini-input" value="5000" readonly>
         <p id="debug-log" style="font-size: 10px; color: #444; margin-top: 5px;">Logs del sistema...</p>
      </div>
    </div>

    <script type="module">
      const invoke = window.__TAURI__.core.invoke;
      const listen = window.__TAURI__.event.listen;

      // Elementos UI
      const btn = document.querySelector("#btn-cloud");
      const roomInput = document.querySelector("#room-code");
      const ring = document.querySelector("#status-ring");
      const icon = document.querySelector("#status-icon");
      const label = document.querySelector("#status-label");
      const log = document.querySelector("#debug-log");

      // Toggle Avanzado
      document.querySelector("#toggle-advanced").addEventListener("click", () => {
        document.querySelector("#advanced-panel").classList.toggle("open");
      });

      // FunciÃ³n Actualizar Estado Visual
      function setStatus(state, message) {
        ring.className = "status-ring"; // Reset
        label.textContent = message;
        
        if (state === "connecting") {
            ring.classList.add("connecting");
            icon.textContent = "âŒ›";
            btn.disabled = true;
            btn.style.background = "#fbbf24";
            btn.textContent = "BUSCANDO...";
        } else if (state === "online") {
            ring.classList.add("online");
            icon.textContent = "âš¡";
            btn.textContent = "CONECTADO";
            btn.style.background = "#10b981";
        } else if (state === "error") {
            ring.classList.add("error");
            icon.textContent = "âŒ";
            btn.disabled = false;
            btn.textContent = "REINTENTAR";
            btn.style.background = "#ef4444";
        } else {
            icon.textContent = "ðŸ”Œ";
            btn.disabled = false;
            btn.textContent = "CONECTAR";
            btn.style.background = "#6366f1";
        }
      }

      // ConexiÃ³n
      async function conectar() {
        const codigo = roomInput.value.toUpperCase();
        const ip = document.querySelector("#ip-virtual").value;
        const port = document.querySelector("#puerto-local").value;

        if (!codigo) { setStatus("error", "FALTA CÃ“DIGO"); return; }

        setStatus("connecting", "CONECTANDO A NUBE...");

        try {
            // Guardar cÃ³digo para la prÃ³xima
            localStorage.setItem("last_room", codigo);

            const respuesta = await invoke("conectar_sala", { 
                codigoSala: codigo,
                puertoLocal: port,
                ipVirtual: ip
            });

            log.textContent = respuesta;

            if (respuesta.includes("CONECTADO") || respuesta.includes("MATCH_FOUND")) {
                setStatus("online", "EN LÃNEA");
            } else {
                setStatus("error", "FALLÃ“");
            }

        } catch (e) {
            log.textContent = e;
            setStatus("error", "ERROR CRÃTICO");
        }
      }

      // Eventos
      btn.addEventListener("click", conectar);
      
      // Cargar Ãºltimo cÃ³digo usado
      const lastRoom = localStorage.getItem("last_room");
      if(lastRoom) roomInput.value = lastRoom;

      // Luces
      listen('trafico-salida', () => {
        const led = document.querySelector("#led-tx");
        led.style.background = "#10b981";
        setTimeout(() => led.style.background = "#333", 50);
      });
      listen('trafico-entrada', () => {
        const led = document.querySelector("#led-rx");
        led.style.background = "#3b82f6";
        setTimeout(() => led.style.background = "#333", 50);
      });

    </script>
  </body>
</html>
