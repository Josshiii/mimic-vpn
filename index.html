<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mimic Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; font-family: 'Inter', sans-serif; }
        body { background-color: #1b2838; color: #c6d4df; height: 100vh; width: 100vw; overflow: hidden; display: flex; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #121418; }
        ::-webkit-scrollbar-thumb { background: #3d4450; border-radius: 3px; }

        .sidebar { width: 260px; background-color: #171a21; border-right: 1px solid #000; padding: 20px; display: flex; flex-direction: column; }
        .profile-card { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #3d4450; }
        .my-avatar { width: 60px; height: 60px; background: linear-gradient(135deg, #66c0f4, #1b2838); border-radius: 50%; margin: 0 auto 10px; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; color: white; border: 2px solid #66c0f4; }
        .my-id-box { background: #000; padding: 5px; font-family: monospace; font-size: 11px; color: #a4d007; border-radius: 4px; margin-top: 5px; cursor: pointer; transition: 0.2s; }
        .my-id-box:hover { background: #1a1a1a; }
        .copy-tooltip { font-size: 9px; color: #666; margin-top: 2px; }

        label { color: #66c0f4; font-size: 11px; font-weight: bold; margin-bottom: 5px; display: block; margin-top: 10px; }
        input { width: 100%; background: #101216; border: 1px solid #3d4450; color: #fff; padding: 8px; border-radius: 4px; font-size: 13px; outline: none; }
        input:focus { border-color: #66c0f4; }

        .btn-host { margin-top: 20px; background: linear-gradient(90deg, #06BFFF 0%, #2D73FF 100%); color: white; border: none; padding: 12px; font-weight: bold; border-radius: 4px; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-host:hover { filter: brightness(1.1); }
        .btn-host:disabled { filter: grayscale(1); cursor: default; }

        .main-content { flex: 1; background: radial-gradient(circle at top, #2a475e 0%, #1b2838 70%); padding: 20px; display: flex; flex-direction: column; }
        .section-title { font-size: 14px; color: #fff; border-bottom: 1px solid #3d4450; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; }
        
        .lobby-list { flex: 1; overflow-y: auto; }
        .lobby-card { background: rgba(0,0,0,0.2); padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #a4d007; transition: 0.2s; }
        .lobby-card:hover { background: rgba(255,255,255,0.05); }
        .btn-join { background: #3d4450; color: #fff; border: none; padding: 5px 15px; font-size: 11px; font-weight: bold; border-radius: 2px; cursor: pointer; }
        .btn-join:hover { background: #a4d007; color: #000; }

        .right-panel { width: 260px; background: #171a21; border-left: 1px solid #000; display: flex; flex-direction: column; }
        .friends-section { flex: 1; padding: 15px; overflow-y: auto; border-bottom: 1px solid #000; max-height: 50%; }
        .add-friend-box { display: flex; gap: 5px; margin-bottom: 10px; }
        .btn-add { background: #3d4450; border: 1px solid #555; color: white; width: 30px; cursor: pointer; border-radius: 4px; }

        .friend-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; }
        .friend-item:hover { background: rgba(255,255,255,0.05); }
        .f-avatar { width: 28px; height: 28px; background: #333; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; color: #888; border: 2px solid #444; }
        .f-avatar.online { border-color: #66c0f4; color: white; background: #2a475e; }
        .f-avatar.playing { border-color: #a4d007; color: white; background: #2a475e; }
        .f-info { display: flex; flex-direction: column; }
        .f-name { font-size: 12px; font-weight: bold; color: #888; }
        .f-name.online { color: #66c0f4; }
        .f-ip { font-size: 10px; color: #555; font-family: monospace; }
        .f-ip.visible { color: #a4d007; }

        .chat-section { flex: 1; display: flex; flex-direction: column; background: #121418; }
        .chat-header { padding: 10px; background: #1e2126; font-size: 11px; font-weight: bold; color: #888; border-bottom: 1px solid #000; display: flex; justify-content: space-between; }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { font-size: 12px; line-height: 1.4; word-wrap: break-word; }
        .msg-sender { font-weight: bold; color: #66c0f4; font-size: 11px; margin-right: 5px; }
        .msg-text { color: #ccc; }
        .sys-msg { color: #a4d007; font-size: 11px; font-style: italic; text-align: center; margin: 5px 0; }
        .chat-input-area { padding: 10px; background: #1e2126; border-top: 1px solid #000; }
        #chat-input { margin: 0; background: #2f3640; border: none; padding: 10px; font-size: 12px; }

        .telemetry-panel { background: #0b0d10; border-top: 1px solid #333; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-family: monospace; }
        .stat-box { background: #171a21; padding: 5px; border-radius: 4px; display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 9px; color: #666; text-transform: uppercase; }
        .stat-value { font-size: 14px; font-weight: bold; color: #fff; }
        .stat-turbo { color: #a4d007; font-size: 10px; }

        .status-bar { height: 25px; background: #000; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; font-size: 10px; color: #666; }
        .hidden { display: none; }

        /* --- NOTIFICACIONES TOAST (Elegantes) --- */
        #toast-container { position: fixed; bottom: 40px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .toast { background: #171a21; border-left: 4px solid #a4d007; padding: 12px 20px; color: white; border-radius: 4px; font-size: 12px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.5); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px; }
        .toast.error { border-left-color: #ef4444; }
        .toast.show { transform: translateX(0); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="profile-card">
            <div class="my-avatar" id="ui-avatar">?</div>
            <div style="font-size: 14px; font-weight: bold; color: white;" id="ui-name-display">Jugador</div>
            <div class="my-id-box" id="my-id-display" onclick="copyToClipboard(document.getElementById('my-id-display').textContent, 'ID Copiado')">CARGANDO...</div>
            <div class="copy-tooltip">Clic para copiar</div>
        </div>
        <label>TU NOMBRE</label>
        <input id="my-name" placeholder="Tu Nickname">
        <label>JUEGO</label>
        <input id="my-game" value="Halo CE">
        <label>CONTRASE√ëA SALA (Opcional)</label>
        <input id="host-password" placeholder="Dejar vac√≠o para P√∫blica" type="password" style="border-color: #a4d007;">
        <button id="btn-host" class="btn-host">CREAR SALA</button>
    </div>

    <div class="main-content">
        <div class="section-title">
            <span>SALAS P√öBLICAS</span>
            <span id="server-status" style="font-size:11px;">Conectando...</span>
        </div>
        <div id="lobby-list" class="lobby-list"></div>
    </div>

    <div class="right-panel">
        <div class="friends-section">
            <div style="font-size: 11px; color: #666; font-weight: bold; margin-bottom: 10px;">AMIGOS (CLIC PARA COPIAR IP)</div>
            <div class="add-friend-box">
                <input id="friend-code-input" placeholder="ID Amigo..." style="margin:0; font-size:11px;">
                <button class="btn-add" onclick="addFriend()">+</button>
            </div>
            <div id="friends-list"></div>
        </div>

        <div class="chat-section">
            <div class="chat-header">
                <span>CHAT DE SALA</span>
                <span id="chat-status" style="color: #555;">‚óè</span>
            </div>
            <div class="chat-messages" id="chat-box">
                <div style="text-align:center; color:#444; font-size:11px; margin-top:20px;">
                    √önete a una sala para chatear
                </div>
            </div>
            <div class="chat-input-area">
                <input id="chat-input" placeholder="Escribe un mensaje..." disabled onkeypress="handleChat(event)">
            </div>
            <div class="telemetry-panel">
                <div class="stat-box">
                    <span class="stat-label">VELOCIDAD</span>
                    <span class="stat-value" id="speed-display">0 KB/s</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">TURBO SAVINGS</span>
                    <span class="stat-value" id="turbo-display">--</span>
                    <span class="stat-turbo">LZ4 ACTIVO</span>
                </div>
            </div>
        </div>
    </div>

    <div class="hidden">
        <input id="ip-virtual" value="">
        <input id="puerto-local" value="5000">
        <input id="my-version" value="v1.0">
    </div>

    <div class="status-bar">
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="ping-dot" style="width:8px; height:8px; background:#333; border-radius:50%;"></div>
            <span id="log-text">Listo</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
             <span id="turbo-icon" style="font-size:10px; color:#333; display:none;">‚ö° TURBO LZ4</span>
            <span id="ping-text" style="font-family:monospace;">--</span>
            <div id="traffic-led" style="width:6px; height:6px; background:#333; border-radius:50%;"></div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        const invoke = window.__TAURI__.core.invoke;
        const listen = window.__TAURI__.event.listen;
        const SERVER_URL = "wss://mimic-signal.onrender.com"; 
        let ws;
        let vpnStarted = false; 

        // --- TOAST SYSTEM (Notificaciones Bonitas) ---
        window.showToast = (msg, type = "info") => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `<span>${type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span><span>${msg}</span>`;
            container.appendChild(el);
            setTimeout(() => el.classList.add('show'), 10);
            setTimeout(() => {
                el.classList.remove('show');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        };
        window.copyToClipboard = (text, msg) => {
            navigator.clipboard.writeText(text);
            showToast(msg || "Copiado al portapapeles");
        };

        // --- SISTEMA ID & IP ---
        let myId = localStorage.getItem('mimic_id');
        if (!myId) {
            myId = 'M-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            localStorage.setItem('mimic_id', myId);
        }
        document.getElementById('my-id-display').textContent = myId;
        function generateIpFromId(id) {
            let hash = 0;
            for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
            return `10.10.10.${(Math.abs(hash) % 253) + 2}`;
        }
        const myAutoIp = generateIpFromId(myId);
        document.getElementById('ip-virtual').value = myAutoIp;

        // --- SONIDOS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if (type === 'msg') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'join') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(440, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(880, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- PERFIL ---
        let savedName = localStorage.getItem('mimic_name') || "Jugador";
        document.getElementById('my-name').value = savedName;
        updateProfileUI(savedName);
        document.getElementById('my-name').addEventListener('input', (e) => {
            localStorage.setItem('mimic_name', e.target.value); updateProfileUI(e.target.value);
            if(ws && ws.readyState === 1) sendLogin(); 
        });
        function updateProfileUI(name) {
            document.getElementById('ui-name-display').textContent = name;
            document.getElementById('ui-avatar').textContent = name.charAt(0).toUpperCase();
        }

        // --- AMIGOS (MODIFICADO: Muestra IP Virtual) ---
        let friends = JSON.parse(localStorage.getItem('mimic_friends')) || [];
        window.addFriend = () => {
            const code = document.getElementById('friend-code-input').value.trim().toUpperCase();
            if (!code || code === myId || friends.some(f => f.id === code)) return;
            friends.push({ id: code, name: `Amigo ${code}` });
            localStorage.setItem('mimic_friends', JSON.stringify(friends));
            renderFriends([]); document.getElementById('friend-code-input').value = "";
        };

        // --- CHAT ---
        window.handleChat = (e) => {
            if (e.key === 'Enter') {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (text) { ws.send(JSON.stringify({ type: 'CHAT', sender: savedName, text: text })); input.value = ""; }
            }
        };
        function addChatMessage(sender, text, isSystem = false) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = "msg";
            if (isSystem) div.innerHTML = `<div class="sys-msg">${text}</div>`;
            else div.innerHTML = `<span class="msg-sender">${sender}:</span><span class="msg-text">${text}</span>`;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }

        // --- L√ìGICA DE RED ---
        async function startVpnEngine(key) {
            if(vpnStarted) return;
            try {
                document.getElementById('log-text').textContent = "Iniciando...";
                await invoke("iniciar_vpn", { puertoLocal: document.getElementById('puerto-local').value, ipVirtual: myAutoIp, claveB64: key });
                vpnStarted = true;
                const turbo = document.getElementById('turbo-icon'); turbo.style.display = "inline"; turbo.style.color = "#a4d007"; turbo.style.textShadow = "0 0 5px #a4d007";
                document.getElementById('log-text').textContent = `Activo (${myAutoIp})`; document.getElementById('log-text').style.color = "#a4d007";
            } catch(e) { console.error("Error motor:", e); }
        }
        async function addPeer(realIp, port, virtualIp) {
            try {
                await invoke("agregar_peer", { ipDestino: realIp + ":" + port, ipVirtual: virtualIp });
                console.log(`Ruta: ${virtualIp} -> ${realIp}:${port}`);
            } catch(e) { console.error(e); }
        }

        // --- TELEMETR√çA ---
        let bytesIn_Net = 0, bytesIn_Game = 0, lastCheck = Date.now();
        listen('stats-entrada', (e) => { const [n, g] = e.payload; bytesIn_Net += n; bytesIn_Game += g; animateLed(); });
        listen('stats-salida', () => { animateLed(); });
        setInterval(() => {
            const now = Date.now(), dur = (now - lastCheck) / 1000; lastCheck = now;
            if (bytesIn_Game > 0) {
                const speed = (bytesIn_Game / 1024) / dur;
                const savings = 100 - ((bytesIn_Net / bytesIn_Game) * 100);
                document.getElementById('speed-display').textContent = speed.toFixed(1) + " KB/s";
                document.getElementById('turbo-display').textContent = (savings > 0 && savings < 100 ? savings.toFixed(0) : "0") + "%";
                document.getElementById('turbo-display').style.color = "#a4d007";
                bytesIn_Net = 0; bytesIn_Game = 0;
            } else {
                document.getElementById('speed-display').textContent = "0 KB/s";
                document.getElementById('turbo-display').textContent = "--";
                document.getElementById('turbo-display').style.color = "#666";
            }
        }, 1000);
        function animateLed() { const led = document.getElementById('traffic-led'); led.style.background = "#a4d007"; led.style.boxShadow = "0 0 5px #a4d007"; setTimeout(()=> { led.style.background="#333"; led.style.boxShadow = "none"; }, 50); }

        // --- WEBSOCKET ---
        function connect() {
            document.getElementById('server-status').textContent = "Conectando...";
            ws = new WebSocket(SERVER_URL);
            ws.onopen = () => {
                document.getElementById('server-status').textContent = "EN L√çNEA"; document.getElementById('server-status').style.color = "#a4d007";
                sendLogin();
            };
            ws.onmessage = async (e) => {
                const msg = JSON.parse(e.data);
                if (msg.type === 'STATE_UPDATE') { renderLobbies(msg.lobbies); renderFriends(msg.players); }
                if (msg.type === 'ERROR') { showToast(msg.message, 'error'); playSound('msg'); } // Usamos Toast
                if (msg.type === 'MATCH') {
                    const key = msg.role === 'HOST' ? window.currentKey : msg.key;
                    await startVpnEngine(key);
                    await addPeer(msg.peer_ip, msg.peer_port, msg.peer_virtual_ip);
                    enableChat(); playSound('join'); showToast("¬°Conexi√≥n Establecida!", "info");
                }
                if (msg.type === 'CHAT_MSG') { addChatMessage(msg.sender, msg.text); if(document.hidden) playSound('msg'); }
            };
            ws.onclose = () => { vpnStarted = false; setTimeout(connect, 3000); };
        }
        function sendLogin() { 
            // NUEVO: ENVIAMOS LA IP VIRTUAL AL CONECTARNOS
            ws.send(JSON.stringify({ type: 'LOGIN', id: myId, name: document.getElementById('my-name').value, virtualIp: myAutoIp })); 
        }

        // --- ACCIONES UI ---
        document.getElementById('btn-host').addEventListener('click', async () => {
            const code = Math.random().toString(36).substring(7);
            const secureKey = await invoke("generar_clave_segura");
            window.currentKey = secureKey; 
            const password = document.getElementById('host-password').value.trim();
            await startVpnEngine(secureKey);
            ws.send(JSON.stringify({
                type: 'HOST', room: code, hostName: document.getElementById('my-name').value,
                gameName: document.getElementById('my-game').value, gameVer: "v1.0", 
                payload: document.getElementById('puerto-local').value, virtualIp: myAutoIp, 
                key: secureKey, password: password
            }));
            document.getElementById('log-text').textContent = "Host Activo";
            document.getElementById('btn-host').disabled = true;
            document.getElementById('host-password').disabled = true;
            enableChat();
        });

        window.join = (code, hasPassword) => {
            let password = "";
            if (hasPassword) {
                password = prompt("üîí Contrase√±a de Sala:");
                if (password === null) return;
            }
            ws.send(JSON.stringify({ type: 'JOIN', room: code, payload: document.getElementById('puerto-local').value, virtualIp: myAutoIp, password: password }));
        };

        function enableChat() { document.getElementById('chat-input').disabled = false; document.getElementById('chat-status').style.color = "#a4d007"; document.getElementById('chat-box').innerHTML = ""; addChatMessage("", "¬°Sistema En L√≠nea!", true); }
        
        function renderFriends(onlinePlayers) {
            const listEl = document.getElementById('friends-list'); listEl.innerHTML = "";
            friends.forEach(friend => {
                const onlineData = onlinePlayers.find(p => p.id === friend.id);
                let statusClass = onlineData ? (onlineData.status === "Jugando" ? "playing" : "online") : "";
                if(onlineData) friend.name = onlineData.name;
                
                // IP VIRTUAL VISIBLE PARA COPIAR
                const ipDisplay = onlineData && onlineData.virtualIp ? onlineData.virtualIp : "Offline";
                const ipClass = onlineData ? "visible" : "";
                
                // Al hacer clic, copiamos la IP
                listEl.innerHTML += `
                    <div class="friend-item" onclick="copyToClipboard('${ipDisplay}', 'IP Copiada: ${ipDisplay}')">
                        <div class="f-avatar ${statusClass}">${friend.name.charAt(0).toUpperCase()}</div>
                        <div class="f-info">
                            <div class="f-name ${statusClass}">${friend.name}</div>
                            <div class="f-ip ${ipClass}">${ipDisplay}</div>
                        </div>
                    </div>`;
            });
            localStorage.setItem('mimic_friends', JSON.stringify(friends));
        }
        
        function renderLobbies(lobbies) {
            const list = document.getElementById('lobby-list'); list.innerHTML = "";
            Object.keys(lobbies).forEach(code => {
                const l = lobbies[code];
                const lockIcon = l.hasPassword ? "üîí" : "";
                const joinText = l.hasPassword ? "ENTRAR" : "UNIRSE";
                list.innerHTML += `<div class="lobby-card"><div><div style="font-weight:bold; color:#fff;">${lockIcon} ${l.gameName}</div><div style="font-size:11px; color:#888;">Host: ${l.hostName}</div></div><button class="btn-join" onclick="window.join('${code}', ${l.hasPassword})">${joinText}</button></div>`;
            });
            if (!list.innerHTML) list.innerHTML = "<div style='text-align:center;color:#444;margin-top:20px'>No hay salas</div>";
        }

        let lastPingTime = Date.now(); let pingInterval;
        listen('evento-ping', () => {
            lastPingTime = Date.now();
            document.getElementById('ping-dot').style.background = "#a4d007"; document.getElementById('ping-dot').style.boxShadow = "0 0 8px #a4d007";
            document.getElementById('ping-text').textContent = "ONLINE"; document.getElementById('ping-text').style.color = "#a4d007";
            setTimeout(() => document.getElementById('ping-dot').style.boxShadow = "none", 200);
            clearTimeout(pingInterval);
            pingInterval = setTimeout(() => { document.getElementById('ping-dot').style.background = "#ef4444"; document.getElementById('ping-text').textContent = "LOST"; document.getElementById('ping-text').style.color = "#ef4444"; }, 5000);
        });

        connect();
    </script>
</body>
</html>
