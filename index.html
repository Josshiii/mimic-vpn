<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mimic Link</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --bg-color: #0f0f13;
        --card-bg: rgba(30, 30, 35, 0.75);
        --primary: #6366f1; 
        --success: #10b981;
        --text-main: #ffffff;
        --text-dim: #9ca3af;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }

      body {
        background-color: var(--bg-color);
        background-image: radial-gradient(circle at 50% 0%, #2d2d44 0%, var(--bg-color) 70%);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        height: 100vh;
        display: flex; justify-content: center; align-items: center; overflow: hidden;
      }

      .app-card {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 100%; height: 100%; max-width: 420px; max-height: 680px; /* Un poco más alto */
        border-radius: 24px; padding: 30px;
        display: flex; flex-direction: column; align-items: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }

      h1 { font-size: 24px; font-weight: 800; background: linear-gradient(to right, #fff, #a5b4fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .subtitle { color: var(--text-dim); font-size: 12px; font-weight: 600; letter-spacing: 1px; margin-bottom: 20px; }

      /* INPUT CÓDIGO */
      .code-container { width: 100%; margin-bottom: 20px; position: relative; }
      .code-label { position: absolute; top: -8px; left: 15px; background: #222; padding: 0 5px; font-size: 10px; color: var(--primary); font-weight: bold; border-radius: 4px; }
      
      input#room-code {
        width: 100%; background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 12px; padding: 15px;
        font-size: 20px; font-weight: 800; color: white; text-align: center; letter-spacing: 3px; text-transform: uppercase;
        outline: none; transition: 0.3s;
      }
      input#room-code:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }

      button#btn-cloud {
        width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary);
        color: white; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 25px;
      }
      button:hover { filter: brightness(1.1); transform: translateY(-2px); }

      /* --- NUEVO: APARTADO DE AMIGOS (SQUAD) --- */
      .squad-title { width: 100%; text-align: left; font-size: 11px; color: #666; font-weight: 700; margin-bottom: 10px; letter-spacing: 1px; }
      
      .squad-container {
        width: 100%;
        background: rgba(0,0,0,0.2);
        border-radius: 16px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }

      .player-card {
        display: flex; align-items: center; gap: 12px;
        padding: 10px; border-radius: 12px;
        background: rgba(255,255,255,0.03);
        border: 1px solid transparent;
        transition: 0.3s;
      }

      .player-card.active { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); }
      .player-card.empty { opacity: 0.5; border-style: dashed; border-color: #444; }

      .avatar {
        width: 35px; height: 35px; border-radius: 50%;
        background: #333; display: flex; justify-content: center; align-items: center;
        font-weight: bold; font-size: 14px;
      }
      .avatar.online { background: linear-gradient(135deg, #6366f1, #a5b4fc); box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
      .avatar.peer { background: linear-gradient(135deg, #10b981, #34d399); }

      .info { display: flex; flex-direction: column; }
      .name { font-size: 13px; font-weight: 600; }
      .status { font-size: 10px; color: #666; display: flex; align-items: center; gap: 5px; }
      
      .dot { width: 6px; height: 6px; border-radius: 50%; background: #444; }
      .dot.green { background: #10b981; box-shadow: 0 0 5px #10b981; }

      /* LUCES DISCRETAS */
      .traffic-lights { display: flex; gap: 8px; position: absolute; bottom: 20px; right: 30px; }
      .led { width: 6px; height: 6px; border-radius: 50%; background: #333; transition: 0.1s; }

      /* TEXTO DE ESTADO */
      .main-status { font-size: 12px; color: #888; margin-top: auto; }

      /* AVANZADO OCULTO */
      #advanced-panel { display: none; }
    </style>
  </head>
  <body>

    <div class="app-card">
      <h1>Mimic Link</h1>
      <p class="subtitle">LOBBY & SQUAD</p>

      <div class="squad-title">MI ESCUADRÓN (2/2)</div>
      <div class="squad-container">
        
        <div class="player-card active">
          <div class="avatar online">YO</div>
          <div class="info">
            <span class="name">Tú (Host)</span>
            <span class="status"><span class="dot green"></span> En Línea</span>
          </div>
        </div>

        <div class="player-card empty" id="p2-card">
          <div class="avatar" id="p2-avatar">?</div>
          <div class="info">
            <span class="name" id="p2-name">Esperando jugador...</span>
            <span class="status" id="p2-status"><span class="dot"></span> Desconectado</span>
          </div>
        </div>

      </div>

      <div class="code-container">
        <span class="code-label">CÓDIGO DE SALA</span>
        <input id="room-code" placeholder="CÓDIGO" maxlength="8">
      </div>

      <button id="btn-cloud">UNIRSE A SALA</button>
      <p class="main-status" id="status-text">Listo para conectar</p>

      <div class="traffic-lights">
        <div id="led-tx" class="led"></div>
        <div id="led-rx" class="led"></div>
      </div>

      <div id="advanced-panel">
         <input id="ip-virtual" value="10.10.10.2">
         <input id="puerto-local" value="5000">
      </div>
    </div>

    <script type="module">
      const invoke = window.__TAURI__.core.invoke;
      const listen = window.__TAURI__.event.listen;

      // Elementos
      const btn = document.querySelector("#btn-cloud");
      const statusText = document.querySelector("#status-text");
      const p2Card = document.querySelector("#p2-card");
      const p2Name = document.querySelector("#p2-name");
      const p2Status = document.querySelector("#p2-status");
      const p2Avatar = document.querySelector("#p2-avatar");

      // Función: Activar Amigo Visualmente
      function amigoConectado(ip) {
        p2Card.classList.remove("empty");
        p2Card.classList.add("active");
        
        p2Avatar.textContent = "P2";
        p2Avatar.classList.add("peer");
        
        p2Name.textContent = "Amigo Conectado";
        p2Status.innerHTML = `<span class="dot green"></span> Conectado vía ${ip}`; // Muestra la IP real pequeña
        
        statusText.textContent = "TÚNEL ESTABLECIDO Y SEGURO";
        statusText.style.color = "#10b981";
      }

      async function conectar() {
        const codigo = document.querySelector("#room-code").value;
        const ip = document.querySelector("#ip-virtual").value;
        const port = document.querySelector("#puerto-local").value;

        if (!codigo) return;

        btn.disabled = true;
        btn.textContent = "BUSCANDO...";
        btn.style.background = "#fbbf24"; // Amarillo
        statusText.textContent = "Contactando servidor...";

        try {
            const respuesta = await invoke("conectar_sala", { 
                codigoSala: codigo,
                puertoLocal: port,
                ipVirtual: ip
            });

            if (respuesta.includes("CONECTADO") || respuesta.includes("MATCH")) {
                btn.textContent = "EN LÍNEA";
                btn.style.background = "#10b981"; // Verde
                
                // Extraemos la IP del mensaje de respuesta para mostrarla
                // La respuesta suele ser "CONECTADO A: 201.x.x.x:5000"
                const ipAmigo = respuesta.split(": ")[1] || "Directo";
                amigoConectado(ipAmigo);
            } else {
                throw "Fallo";
            }

        } catch (e) {
            btn.disabled = false;
            btn.textContent = "REINTENTAR";
            btn.style.background = "#ef4444";
            statusText.textContent = "Error: " + e;
        }
      }

      document.querySelector("#btn-cloud").addEventListener("click", conectar);

      // Luces
      listen('trafico-salida', () => {
        const l = document.querySelector("#led-tx");
        l.style.background = "#10b981"; setTimeout(()=>l.style.background="#333",50);
      });
      listen('trafico-entrada', () => {
        const l = document.querySelector("#led-rx");
        l.style.background = "#3b82f6"; setTimeout(()=>l.style.background="#333",50);
      });
    </script>
  </body>
</html>
