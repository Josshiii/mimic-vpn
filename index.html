<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mimic Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; font-family: 'Inter', sans-serif; }
        body { background-color: #1b2838; color: #c6d4df; height: 100vh; width: 100vw; overflow: hidden; display: flex; }

        /* --- IZQUIERDA: PERFIL --- */
        .sidebar { width: 280px; background-color: #171a21; border-right: 1px solid #000; padding: 20px; display: flex; flex-direction: column; }
        
        .profile-card { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #3d4450; }
        .my-avatar { width: 60px; height: 60px; background: linear-gradient(135deg, #66c0f4, #1b2838); border-radius: 50%; margin: 0 auto 10px; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; color: white; border: 2px solid #66c0f4; }
        
        .my-id-box { background: #000; padding: 5px; font-family: monospace; font-size: 11px; color: #a4d007; border-radius: 4px; margin-top: 5px; cursor: pointer; }
        .my-id-box:hover { background: #222; }
        .copy-tooltip { font-size: 9px; color: #666; margin-top: 2px; }

        label { color: #66c0f4; font-size: 11px; font-weight: bold; margin-bottom: 5px; display: block; margin-top: 15px; }
        input { width: 100%; background: #101216; border: 1px solid #3d4450; color: #fff; padding: 8px; border-radius: 4px; font-size: 13px; outline: none; }
        input:focus { border-color: #66c0f4; }

        .btn-host { margin-top: 20px; background: linear-gradient(90deg, #06BFFF 0%, #2D73FF 100%); color: white; border: none; padding: 12px; font-weight: bold; border-radius: 4px; cursor: pointer; width: 100%; }
        .btn-host:hover { filter: brightness(1.1); }
        .btn-host:disabled { filter: grayscale(1); }

        /* --- CENTRO: SALAS --- */
        .main-content { flex: 1; background: radial-gradient(circle at top, #2a475e 0%, #1b2838 70%); padding: 20px; display: flex; flex-direction: column; }
        .section-title { font-size: 14px; color: #fff; border-bottom: 1px solid #3d4450; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; }
        
        .lobby-list { flex: 1; overflow-y: auto; }
        .lobby-card { background: rgba(0,0,0,0.2); padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #a4d007; transition: 0.2s; }
        .lobby-card:hover { background: rgba(255,255,255,0.05); }
        .btn-join { background: #3d4450; color: #fff; border: none; padding: 5px 15px; font-size: 11px; font-weight: bold; border-radius: 2px; cursor: pointer; }
        .btn-join:hover { background: #a4d007; color: #000; }

        /* --- DERECHA: AMIGOS --- */
        .friends-panel { width: 240px; background: #171a21; border-left: 1px solid #000; padding: 15px; display: flex; flex-direction: column; }
        
        .add-friend-box { display: flex; gap: 5px; margin-bottom: 15px; }
        .add-friend-box input { margin: 0; font-size: 11px; }
        .btn-add { background: #3d4450; border: 1px solid #555; color: white; width: 30px; cursor: pointer; border-radius: 4px; }
        .btn-add:hover { background: #a4d007; color: black; border-color: #a4d007; }

        .friends-list { flex: 1; overflow-y: auto; }
        
        .friend-item { display: flex; align-items: center; gap: 10px; padding: 8px 5px; border-bottom: 1px solid #222; }
        .f-avatar { width: 32px; height: 32px; background: #333; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #888; border: 2px solid #444; position: relative; }
        .f-avatar.online { border-color: #66c0f4; color: white; background: #2a475e; }
        .f-avatar.playing { border-color: #a4d007; color: white; background: #2a475e; }
        
        .f-info { display: flex; flex-direction: column; }
        .f-name { font-size: 13px; font-weight: bold; color: #888; }
        .f-name.online { color: #66c0f4; }
        .f-status { font-size: 10px; color: #555; }
        .f-status.online { color: #66c0f4; }
        .f-status.playing { color: #a4d007; }

        /* ESTADO */
        .status-bar { height: 25px; background: #000; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; font-size: 10px; color: #666; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="profile-card">
            <div class="my-avatar" id="ui-avatar">?</div>
            <div style="font-size: 14px; font-weight: bold; color: white;" id="ui-name-display">Jugador</div>
            
            <div style="margin-top: 10px; font-size: 10px; color: #888;">TU CÃ“DIGO DE AMIGO:</div>
            <div class="my-id-box" id="my-id-display" onclick="copyId()">CARGANDO...</div>
            <div class="copy-tooltip">Clic para copiar</div>
        </div>

        <label>TU NOMBRE</label>
        <input id="my-name" placeholder="Tu Nickname">

        <label>JUEGO</label>
        <input id="my-game" value="Halo CE">
        <label>VERSIÃ“N</label>
        <input id="my-version" value="v1.0">

        <button id="btn-host" class="btn-host">CREAR SALA</button>
    </div>

    <div class="main-content">
        <div class="section-title">
            <span>SALAS PÃšBLICAS</span>
            <span id="server-status" style="font-size:11px;">Conectando...</span>
        </div>
        <div id="lobby-list" class="lobby-list">
            </div>
    </div>

    <div class="friends-panel">
        <div class="section-title" style="font-size: 12px;">AMIGOS</div>
        
        <div class="add-friend-box">
            <input id="friend-code-input" placeholder="Pegar ID de amigo...">
            <button class="btn-add" onclick="addFriend()">+</button>
        </div>

        <div id="friends-list" class="friends-list">
            </div>
    </div>

    <div class="hidden">
        <input id="ip-virtual" value="10.10.10.2">
        <input id="puerto-local" value="5000">
    </div>

    <div class="status-bar">
        <span id="log-text">Iniciando sistema...</span>
        <div id="traffic-led" style="width:8px; height:8px; background:#333; border-radius:50%;"></div>
    </div>

    <script type="module">
const invoke = window.__TAURI__.core.invoke;
    const listen = window.__TAURI__.event.listen;
    const SERVER_URL = "wss://mimic-signal.onrender.com"; 
    let ws;

    // --- SISTEMA DE PERFIL LOCAL (Igual que antes) ---
    let myId = localStorage.getItem('mimic_id');
    if (!myId) {
        myId = 'M-' + Math.random().toString(36).substr(2, 6).toUpperCase();
        localStorage.setItem('mimic_id', myId);
    }
    document.getElementById('my-id-display').textContent = myId;

    let savedName = localStorage.getItem('mimic_name') || "Jugador";
    document.getElementById('my-name').value = savedName;
    document.getElementById('ui-name-display').textContent = savedName;
    document.getElementById('ui-avatar').textContent = savedName.charAt(0).toUpperCase();

    let friends = JSON.parse(localStorage.getItem('mimic_friends')) || [];

    document.getElementById('my-name').addEventListener('input', (e) => {
        localStorage.setItem('mimic_name', e.target.value);
        document.getElementById('ui-name-display').textContent = e.target.value;
        document.getElementById('ui-avatar').textContent = e.target.value.charAt(0).toUpperCase();
        if(ws && ws.readyState === 1) sendLogin(); 
    });

    window.copyId = () => {
        navigator.clipboard.writeText(myId);
        document.getElementById('log-text').textContent = "ID copiado";
    };

    window.addFriend = () => {
        const input = document.getElementById('friend-code-input');
        const code = input.value.trim().toUpperCase();
        if (!code) return;
        if (code === myId) { alert("No puedes agregarte a ti mismo"); return; }
        if (friends.some(f => f.id === code)) { alert("Ya es tu amigo"); return; }
        friends.push({ id: code, name: "Amigo (" + code + ")" });
        localStorage.setItem('mimic_friends', JSON.stringify(friends));
        input.value = "";
        renderFriends([]); 
        alert("Amigo agregado.");
    };

    // --- RED ---
    function connect() {
        document.getElementById('server-status').textContent = "Conectando...";
        ws = new WebSocket(SERVER_URL);

        ws.onopen = () => {
            document.getElementById('server-status').textContent = "EN LÃNEA";
            document.getElementById('server-status').style.color = "#a4d007";
            sendLogin();
        };

        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            
            if (msg.type === 'STATE_UPDATE') {
                renderLobbies(msg.lobbies);
                renderFriends(msg.players);
            }
            
            if (msg.type === 'MATCH') {
                // RECIBIMOS LA CLAVE DE ENCRIPTACIÃ“N AQUÃ
                startTunnel(msg.peer_ip, msg.peer_port, msg.role, msg.key);
            }
        };

        ws.onclose = () => setTimeout(connect, 3000);
    }

    function sendLogin() {
        const name = document.getElementById('my-name').value;
        ws.send(JSON.stringify({ type: 'LOGIN', id: myId, name: name }));
    }

    // --- RENDERIZADO (Igual que antes) ---
    function renderFriends(onlinePlayers) {
        const listEl = document.getElementById('friends-list');
        listEl.innerHTML = "";
        if (friends.length === 0) {
            listEl.innerHTML = "<div style='color:#555; font-size:10px; text-align:center; margin-top:20px;'>Agrega amigos con su ID</div>";
            return;
        }
        friends.forEach(friend => {
            const onlineData = onlinePlayers.find(p => p.id === friend.id);
            let statusClass = "";
            let statusText = "Offline";
            if (onlineData) {
                friend.name = onlineData.name;
                statusClass = onlineData.status === "Jugando" ? "playing" : "online";
                statusText = onlineData.status === "Jugando" ? onlineData.game : "En LÃ­nea";
            }
            const html = `
                <div class="friend-item">
                    <div class="f-avatar ${statusClass}">${friend.name.charAt(0).toUpperCase()}</div>
                    <div class="f-info">
                        <span class="f-name ${statusClass}">${friend.name}</span>
                        <span class="f-status ${statusClass}">${statusText}</span>
                    </div>
                </div>
            `;
            listEl.innerHTML += html;
        });
        localStorage.setItem('mimic_friends', JSON.stringify(friends));
    }

    function renderLobbies(lobbies) {
        const list = document.getElementById('lobby-list');
        list.innerHTML = "";
        const codes = Object.keys(lobbies);
        if(codes.length === 0) {
            list.innerHTML = "<div style='text-align:center; color:#555; margin-top:40px;'>No hay salas pÃºblicas</div>";
            return;
        }
        codes.forEach(code => {
            const l = lobbies[code];
            const html = `
                <div class="lobby-card">
                    <div>
                        <div style="font-weight:bold; color:#fff;">${l.gameName}</div>
                        <div style="font-size:11px; color:#888;">Host: ${l.hostName}</div>
                    </div>
                    <button class="btn-join" onclick="window.join('${code}')">UNIRSE</button>
                </div>
            `;
            list.innerHTML += html;
        });
    }

    // --- ACCIONES CRÃTICAS ACTUALIZADAS ---
    
    // AL CREAR SALA: Generamos una llave y la enviamos al servidor
    document.getElementById('btn-host').addEventListener('click', async () => {
        const code = Math.random().toString(36).substring(7);
        const name = document.getElementById('my-name').value;
        const game = document.getElementById('my-game').value;
        const ver = document.getElementById('my-version').value;
        const port = document.getElementById('puerto-local').value;

        // 1. Generar Clave Militar en Rust
        const secureKey = await invoke("generar_clave_segura");

        // 2. Guardarla en memoria temporalmente (somos el Host)
        window.currentKey = secureKey;

        // 3. Enviarla al servidor (viaja por TLS/SSL seguro)
        // Nota: Solo se la daremos al cliente que se una
        ws.send(JSON.stringify({
            type: 'HOST', room: code, hostName: name, gameName: game, gameVer: ver, payload: port, key: secureKey
        }));
        
        document.getElementById('log-text').textContent = "Sala Segura Creada.";
        document.getElementById('btn-host').disabled = true;
    });

    window.join = (code) => {
        const port = document.getElementById('puerto-local').value;
        ws.send(JSON.stringify({ type: 'JOIN', room: code, payload: port }));
    };

    // AL CONECTAR: Usamos la clave recibida
    async function startTunnel(ip, port, role, receivedKey) {
        document.getElementById('log-text').textContent = "Estableciendo Enlace Seguro...";
        document.getElementById('log-text').style.color = "#a4d007";
        
        // Si somos HOST, usamos la clave que generamos. Si somos CLIENT, usamos la recibida.
        const keyToUse = role === 'HOST' ? window.currentKey : receivedKey;

        try {
            await invoke("conectar_tunel", { 
                ipDestino: ip + ":" + port, 
                puertoLocal: document.getElementById('puerto-local').value,
                ipVirtual: document.getElementById('ip-virtual').value,
                claveB64: keyToUse // <--- Pasamos la clave a Rust
            });
            document.getElementById('log-text').textContent = "ðŸ”’ CONEXIÃ“N ENCRIPTADA (ChaCha20)";
        } catch (e) { console.error(e); }
    }

    connect();
    listen('trafico-entrada', () => {
        const led = document.getElementById('traffic-led');
        led.style.background = "#a4d007"; setTimeout(()=>led.style.background="#333", 50);
    });
    </script>
</body>
</html>
